# Horse ID Assignment and Tracking Mismatch Investigation Report

## Executive Summary

The system has **THREE DISTINCT ID SYSTEMS** for horses that can cause visible mismatches between different sections of the UI:

1. **`id` (UUID)** - Database primary key, globally unique, stored in PostgreSQL
2. **`tracking_id` (String)** - Stream-scoped tracking identifier from ML service (e.g., "stream1_horse_001")
3. **`horses` table** - Primary persistent horse registry in database (differs from chunk detection data)

## Root Cause Analysis

### The Fundamental Problem

The ML service generates horse IDs during chunk processing based on **stream-scoped context**, but the frontend displays horses based on data from **two separate sources**:

#### Source 1: DetectedHorses Tab (`/api/v1/streams/:id/horses`)
- Returns horses from the **horses registry table** (PostgreSQL)
- Shows DATABASE `id` (UUID) and `tracking_id` fields
- These are persistent horses that have been saved to the barn registry
- Sourced from `HorseRepository.findAll(farmId)` - returns **ALL farm horses**, not stream-specific

#### Source 2: RecordedChunks Tab (Chunk JSON `/api/v1/streams/:id/chunks/:chunkId/detections`)
- Returns horses from the **chunk detection JSON** 
- Generated by ML service during `process_chunk_with_video_output()`
- Uses tracking IDs from the tracker (format: `stream1_horse_001`, `stream1_horse_002`, etc.)
- These are **transient IDs** specific to that processing session

## ID System Breakdown

### 1. ML Service ID Assignment (horse_tracker.py)

```
Track ID Format: "{stream_id}_horse_{counter:03d}"
Example: "stream1_horse_001", "stream1_horse_002", "stream1_horse_003"
```

**Key Points:**
- Line 18-20 in horse_tracker.py: `HorseTrack` has `id` (string) and `tracking_id` (int)
- Line 594-599: `_create_new_track()` generates stream-scoped IDs
- Line 820-826: Each chunk processing initializes a NEW `HorseTracker` instance per stream
- Line 1051-1060: Saves all horse states to registry after chunk completes

**Issue:** Each chunk processing session starts fresh with `next_track_id = 1`, so IDs restart numbering per chunk.

### 2. Database Horse Registry

**horses table columns:**
- `id` (UUID PRIMARY KEY) - Globally unique, auto-generated
- `tracking_id` (VARCHAR UNIQUE) - Stream-scoped identifier  
- `farm_id` (UUID) - Which barn owns this horse
- `stream_id` (UUID) - Original stream where first detected
- `status` ('active' | 'deleted') - Soft delete flag
- Other fields: name, breed, color, features, thumbnails, etc.

**Query in HorseRepository.findAll():**
```sql
SELECT * FROM horses 
WHERE farm_id = $1 AND status != 'deleted' 
ORDER BY last_seen DESC
```

### 3. Frontend Display

**DetectedHorsesTab.tsx (Line 225-244):**
```typescript
// Filters storeHorses from Zustand store
// Source: GET /api/v1/streams/:streamId/horses
// Returns horse.tracking_id and other database fields
filteredHorses.filter(horse => {
  const trackingId = horse.tracking_id.toLowerCase();
  return name.includes(search) || trackingId.includes(search);
})
```

**RecordedChunks (Chunk JSON):**
```json
{
  "frame_results": [{
    "tracked_horses": [{
      "id": "stream1_horse_001",
      "tracking_id": 1,
      "color": "#ff6b6b",
      "total_detections": 5
    }]
  }]
}
```

## The Mismatch Scenario

### Example: Why You See Different IDs

**Setup:**
- Stream: `stream1`  
- Farm has 3 horses in database (IDs 15, 6, 13 from previous sessions)
- New chunk is recorded with 3 new horse detections

**DetectedHorses Tab Shows: 15, 6, 13**
- Source: `streamHorseService.getStreamHorses()` → `HorseRepository.findAll(farmId)`
- Query: Returns ALL horses in the farm that exist in the horses table
- These IDs come from the database `tracking_id` field

**RecordedChunks Overlay Shows: 16, 17, 18**
- Source: Chunk JSON from ML service
- These are **NEW** tracking IDs assigned during chunk processing
- Generated by `HorseTracker._create_new_track()` in the ML service
- Format: The ML service's internal tracking counter

**Video Overlay Shows: 16, 17, 18**
- These are drawn from the same chunk JSON
- Come from the tracking IDs assigned during `process_chunk_with_video_output()`

## Data Flow Diagram

```
Stream Processing
  ↓
ML Service (horse_tracker.py)
  • Initializes fresh tracker: next_track_id = 1
  • Detects horses, assigns stream-scoped IDs
  • Generates: "stream1_horse_001", "stream1_horse_002", etc.
  ↓
process_chunk_with_video_output() [Line 1048-1060]
  • Saves horse states to registry
  • Calls: horse_db.save_stream_horse_registry(stream_id, all_horse_states)
  ↓
Redis Cache & PostgreSQL horses table
  • Stores/updates tracking_id and other fields
  • But uses UPSERT on CONFLICT(tracking_id)
  ↓
Chunk JSON Output
  • Contains "tracked_horses" with tracking_id from THIS chunk session
  • IDs: 1, 2, 3 (local to this chunk)
  ↓
Frontend Display
  
  DetectedHorses Tab:
    • Fetches all horses from DB (farmId-scoped)
    • Shows persistent IDs from previous chunks
    • Source: GET /api/v1/streams/:id/horses
    
  RecordedChunks:
    • Shows horses from chunk JSON
    • Source: GET /api/v1/streams/:id/chunks/:chunkId/detections
```

## Key Code References

### 1. ML Service Horse ID Creation (horse_tracker.py:594-599)
```python
def _create_new_track(self, detection, features, timestamp, frame):
    # Generate stream-scoped tracking ID
    clean_id = self.stream_id.replace('-', '_').replace('stream_', '')
    track_id = f"{clean_id}_horse_{self.next_track_id:03d}"
    self.next_track_id += 1
```

### 2. Chunk Processing Initialization (processor.py:820-826)
```python
self.horse_tracker = HorseTracker(
    similarity_threshold=0.7,
    max_lost_frames=30,
    stream_id=stream_id,
    known_horses=known_horses,
    allow_new_horses=allow_new_horses
)
```
**Problem:** Creates new tracker each chunk with `next_track_id = 1`

### 3. Saving Horses to Registry (processor.py:1048-1060)
```python
all_horse_states = self.horse_tracker.get_all_horse_states()
for horse_id, horse_state in all_horse_states.items():
    thumbnail_bytes = self.horse_tracker.get_best_thumbnail(horse_id)
    if thumbnail_bytes:
        horse_state["thumbnail_bytes"] = thumbnail_bytes

await self.horse_db.save_stream_horse_registry(stream_id, all_horse_states)
```

### 4. Database Upsert (horse_database.py:773-791)
```python
cursor.execute("""
    INSERT INTO horses (...) 
    VALUES (...)
    ON CONFLICT (tracking_id) DO UPDATE SET
        last_seen = to_timestamp(%s),
        total_detections = horses.total_detections + 1,
        ...
""")
```

### 5. Frontend Retrieval (streamHorseService.ts:108-116)
```typescript
// Fetch ALL horses for this farm/barn
const horses = await this.horseRepository.findAll(farmId);
return horses;
```

## Cross-Session Continuity Problem

### How `known_horses` Work (processor.py:749)
```python
# Load horses from ALL streams in the same barn/farm
known_horses = await self.horse_db.load_barn_horse_registry(stream_id)
```

This loads **previously detected horses** from Redis/PostgreSQL, allowing:
- Horse re-identification across chunks
- Consistent tracking_id assignment

**But:** The chunk JSON still shows the **NEW session's tracking counter** (1, 2, 3...), not the persistent IDs.

## Why This Matters

### Three Different "Horse 1" Concepts

1. **Database Horse ID 1**: First horse ever saved to this farm's registry (persistent, UUID)
2. **Tracking ID "stream1_horse_001"**: First horse detected in current chunk (transient, session-specific)  
3. **UI Display "1"**: What the frontend shows from `tracking_id` parsing

## Current Behavior Summary

| Component | ID Format | Scope | Persistence |
|-----------|-----------|-------|-------------|
| ML Tracker | "stream1_horse_001" | Stream | Per chunk (session) |
| Chunk JSON | "tracked_horses" IDs | Stream | Per chunk only |
| Database | UUID + tracking_id | Farm | Permanent |
| DetectedHorses Tab | tracking_id from DB | Farm | Across chunks |
| Video Overlay | tracking_id from JSON | Stream | Current chunk only |

## Recommendations for Fix

1. **Option A: Use Database IDs in Chunk JSON**
   - Replace tracking_id with database UUID in chunk JSON output
   - Requires looking up database records before saving chunk JSON
   - **Benefit:** Perfect consistency across all tabs

2. **Option B: Normalize to Persistent Tracking IDs**
   - Have ML service load existing tracking_ids from database
   - Use those IDs instead of auto-incrementing counter
   - **Benefit:** Maintains current structure with better continuity

3. **Option C: Separate Display Logic**
   - Keep ML IDs as-is (transient)
   - Map them to database IDs for UI display only
   - **Benefit:** Minimal code changes, but adds mapping complexity

## Files Involved

**ML Service:**
- `/Users/kevinbrice/GIT/BarnHand/backend/ml-service/src/models/horse_tracker.py` (ID assignment)
- `/Users/kevinbrice/GIT/BarnHand/backend/ml-service/src/services/processor.py` (chunk processing & saving)
- `/Users/kevinbrice/GIT/BarnHand/backend/ml-service/src/services/horse_database.py` (persistence)

**Database:**
- `/Users/kevinbrice/GIT/BarnHand/backend/database/src/migrations/sql/001_initial_schema.sql` (horses table)
- `/Users/kevinbrice/GIT/BarnHand/backend/database/src/repositories/HorseRepository.ts` (queries)

**Frontend:**
- `/Users/kevinbrice/GIT/BarnHand/frontend/src/components/DetectedHorsesTab.tsx` (horse display)
- `/Users/kevinbrice/GIT/BarnHand/backend/api-gateway/src/routes/streams.ts` (API endpoints)
- `/Users/kevinbrice/GIT/BarnHand/backend/api-gateway/src/services/streamHorseService.ts` (horse retrieval)

## Verification Steps

To confirm this is the issue:

1. Check the chunk JSON returned by `/api/v1/streams/:id/chunks/:chunkId/detections`
   - Look at `frame_results[0].tracked_horses[0].tracking_id`
   - Should be sequential: 1, 2, 3... (per chunk)

2. Check the DetectedHorses tab response from `/api/v1/streams/:id/horses`
   - Look at `horses[0].tracking_id`
   - Should be persistent: "stream1_horse_001", etc. (from database)

3. Query the database directly:
   ```sql
   SELECT id, tracking_id, farm_id, last_seen FROM horses ORDER BY last_seen DESC LIMIT 5;
   ```
   - Should match the tracking_ids in DetectedHorses tab

