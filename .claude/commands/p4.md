# Phase 4: Detection Correction & Re-Processing - Task Execution

You are implementing **Phase 4** of BarnHand: manual detection correction with automatic chunk re-processing.

## QUICK START

**Read these FIRST** (in order):

1. `docs/Phase 4 - Detection Correction/detection-correction-tasks.md` - Find current task
2. `docs/HANDOFF_NOTES.md` - Last session context (if exists)
3. `git status` - Current changes

**Phase 4 Docs**:

- **Overview**: `docs/Phase 4 - Detection Correction/detection-correction-overview.md`
- **Tasks**: `docs/Phase 4 - Detection Correction/detection-correction-tasks.md`

## TASK EXECUTION

### 1. Find Current Task

Look in `detection-correction-tasks.md` for:

- `[~]` = In progress (YOUR TASK)
- `[ ]` = Next task if none in progress

Read your task section: **Objective**, **Files**, **Steps**, **Testing**, **Acceptance**, **Reference**

### 2. Implement Task Steps

Follow steps 1-N in your task. For each step:

- Read "Reference" code pattern first
- Implement the step
- Commit: `p4(task-X.Y): <step description>`

**Key Patterns**:

```typescript
// Correction API Endpoint (Task 1.3)
router.post(
  '/:id/chunks/:chunkId/corrections',
  validateSchema(batchCorrectionSchema),
  requireRole([UserRole.FARM_ADMIN, UserRole.FARM_USER]),
  createAuthenticatedRoute(async (req, res) => {
    const { corrections } = req.body;

    // Submit to service
    const result = await correctionService.submitCorrections(
      req.params.chunkId,
      corrections,
      req.user.userId
    );

    // Return 202 Accepted (async processing)
    return res.status(202).json({
      message: 'Corrections queued for processing',
      reprocessing_url: `/api/v1/streams/${req.params.id}/chunks/${req.params.chunkId}/corrections/status`,
      corrections_count: corrections.length
    });
  })
);
```

```python
# Re-Processing Service (Task 1.4) - CRITICAL
class ReprocessorService:
    async def reprocess_chunk(self, chunk_id: str, corrections: List[Dict]) -> ReprocessingResult:
        """Apply corrections and regenerate chunk data."""
        try:
            # Step 1: Load chunk data
            chunk = await self.load_chunk_metadata(chunk_id)
            frames = await self.load_chunk_frames(chunk_id)

            # Step 2: Apply corrections to tracking data
            updated_detections = await self.apply_corrections(chunk, corrections)

            # Step 3: Update ReID feature vectors
            await self.update_reid_features(updated_detections, frames)
            await self.emit_progress(chunk_id, 30, "Updated ReID features")

            # Step 4: Regenerate frames with corrected overlays
            await self.regenerate_frames(chunk_id, frames, updated_detections)
            await self.emit_progress(chunk_id, 70, "Regenerated frames")

            # Step 5: Rebuild video chunk
            await self.rebuild_video_chunk(chunk_id)
            await self.emit_progress(chunk_id, 90, "Rebuilt video")

            # Step 6: Update database
            await self.update_database(chunk_id, corrections, updated_detections)
            await self.emit_progress(chunk_id, 100, "Complete")

            return ReprocessingResult(
                chunk_id=chunk_id,
                corrections_applied=len(corrections),
                frames_updated=len(frames),
                duration=time.time() - start_time
            )

        except Exception as error:
            logger.error(f"Re-processing failed: {error}")
            await self.emit_error(chunk_id, str(error))
            raise
```

```typescript
// Frontend Correction Modal (Task 2.1)
export const DetectionCorrectionModal: React.FC<Props> = ({
  isOpen,
  onClose,
  detection,
  frameIndex,
  allHorses,
  onSubmit,
}) => {
  const [correctionType, setCorrectionType] = useState<CorrectionType>('reassign');
  const [targetHorseId, setTargetHorseId] = useState<string>('');

  const handleSubmit = () => {
    const correction: CorrectionPayload = {
      detection_index: detection.id,
      frame_index: frameIndex,
      correction_type: correctionType,
      original_horse_id: detection.id,
      corrected_horse_id: correctionType === 'reassign' ? targetHorseId : undefined,
      corrected_horse_name: correctionType === 'new_guest' ? `Guest Horse ${allHorses.length + 1}` : undefined,
    };

    onSubmit(correction);
    onClose();
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Correct Detection">
      <div className="space-y-4">
        {/* Correction type radio buttons */}
        <div>
          <label className="flex items-center gap-2">
            <input
              type="radio"
              checked={correctionType === 'reassign'}
              onChange={() => setCorrectionType('reassign')}
            />
            <span>Reassign to existing horse</span>
          </label>
          {correctionType === 'reassign' && (
            <select
              value={targetHorseId}
              onChange={(e) => setTargetHorseId(e.target.value)}
              className="mt-2 w-full"
            >
              <option value="">Select horse...</option>
              {allHorses.filter(h => h.id !== detection.id).map(horse => (
                <option key={horse.id} value={horse.id}>
                  {horse.name || `Horse ${horse.id}`}
                </option>
              ))}
            </select>
          )}
        </div>

        {/* Other correction types... */}

        <button onClick={handleSubmit} className="btn-primary">
          Add Correction
        </button>
      </div>
    </Modal>
  );
};
```

### 3. Test (Complete ALL before next task)

Check off boxes in task "Testing" section:

- [ ] Unit tests
- [ ] Integration tests
- [ ] Regression tests
- [ ] Manual tests

```bash
# Test commands
docker compose up -d --build api-gateway ml-service frontend
docker compose logs -f ml-service

# Frontend tests
cd frontend && npm test

# Backend tests
cd backend/ml-service && pytest tests/

# E2E tests
cd testing/e2e && npx playwright test
```

### 4. Mark Complete

Update task in `detection-correction-tasks.md`:

- Change `[ ]` to `[x]` when all Testing + Acceptance boxes checked
- Update `docs/HANDOFF_NOTES.md` with progress

## CRITICAL TASKS

**Task 1.4** (ML Re-Processing Service):

- `reprocessor.py:NEW` - Core re-processing logic
- Apply corrections → Update ReID → Regenerate frames → Rebuild video
- **MUST** emit WebSocket progress events at each step
- **MUST** handle errors gracefully with rollback

**Task 1.5** (ML API Endpoints):

- `main.py:40-80` - Add FastAPI endpoints
- Return 202 Accepted immediately (async processing)
- Store progress in Redis: `reprocessing:{chunk_id}:status`

**Task 2.1** (Correction Modal):

- `DetectionCorrectionModal.tsx:NEW` - Modal component
- Support 3 correction types: reassign, new_guest, mark_incorrect
- Validate: can't reassign to same horse

**Task 3.1** (WebSocket Events):

- Add `reprocessing:progress` event
- Add `chunk:updated` event when complete
- Frontend subscribes in `useWebSocket.ts`

## QUICK DEBUG

```bash
# Correction not submitting?
curl -X POST http://localhost:8000/api/v1/streams/{id}/chunks/{chunkId}/corrections \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"corrections": [...]}'

# Re-processing stuck?
docker compose exec redis redis-cli GET "reprocessing:{chunk_id}:status"
docker compose logs -f ml-service | grep "reprocess"

# Frames not updating?
ls -la /data/chunks/{chunk_id}/frames/
docker compose exec ml-service ls /data/chunks/{chunk_id}/frames/

# WebSocket events not firing?
# Open browser DevTools → Network → WS tab → watch for events
```

## COMMON ISSUES

**Issue 1: Re-processing fails silently**

- Check ML service logs: `docker compose logs -f ml-service`
- Verify corrections payload is valid JSON
- Check Redis for error status: `GET reprocessing:{chunk_id}:status`

**Issue 2: Frames not regenerating**

- Verify frame renderer extracted from processor.py correctly
- Check file permissions on `/data/chunks/` directory
- Ensure FFmpeg installed in ml-service container

**Issue 3: ReID features not updating**

- Check horse_database.py logs for feature update calls
- Verify PostgreSQL vector extension enabled
- Check Redis cache invalidation

**Issue 4: Frontend not showing progress**

- Verify WebSocket connection established
- Check browser console for WebSocket errors
- Ensure reprocessingStore subscribed to events

---

**NOW**: Check `docs/Phase 4 - Detection Correction/detection-correction-tasks.md` for your current task and execute steps 1-4.
