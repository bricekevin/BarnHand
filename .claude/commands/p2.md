```markdown
# Phase 2 Chunk Processing Work Session

You are about to work on the BarnHand Phase 2 chunk processing enhancement. Follow these steps carefully:

## 1. PROJECT CONTEXT

Review the project structure and current state:

- Read `BarnHand/CLAUDE.md` for project overview
- Read `BarnHand/p2.md` for the complete task list
- Check the "Last Work Session Notes" section **at the very bottom** of p2.md
- Review the working ML pipeline code: `BarnHand/backend/ml-service/test_advanced_state_pipeline.py`

## 2. ASSESS CURRENT STATE

1. Check git status to see any uncommitted work
2. Review which tasks are marked [x] vs [ ] in the task list
3. Read the handoff notes to understand what was last completed
4. Run `docker ps` to check if services are running

## 3. SELECT NEXT TASKS

Choose 2-4 related tasks that form a logical unit of work. Prioritize:

- Tasks that unblock other work
- Following the suggested implementation order (Phase 0 → 1 → 2 → 3 → 4)
- Complete one small feature end-to-end rather than partial work on many features
- **If starting fresh, begin with Phase 0: Map Current System**

## 4. WORK APPROACH

For each selected task:

1. Mark it as "IN PROGRESS" by updating [ ] to [~] in the task list
2. Implement with clear commits (use conventional commits: feat:, fix:, test:, docs:)
3. Add comprehensive logging at each step
4. Test in Docker environment: `docker-compose up --build -d`
5. Verify frontend at http://localhost:5174
6. Mark completed tasks with [x]

## 5. KEY TECHNICAL DETAILS

- **Working ML Pipeline Code**: `backend/ml-service/test_advanced_state_pipeline.py`
  - This is YOUR WORKING REFERENCE for YOLO + RTMPose + ReID integration
  - Contains `AdvancedStatePipeline` class with overlay rendering
  - Use this as the foundation for the new `ChunkProcessor`
- **Chunk Storage**: `/chunks/{farmId}/{streamId}/{raw|processed|detections}/`
- **Critical**: Modify existing video playback endpoint, don't create parallel system
- **Frontend Port**: 5174 (development)
- **API Gateway**: Port 8000
- **ML Service**: Port 8002
- **Auth Token**: Use token from login (admin@barnhand.com / admin123)

## 6. UPDATE DOCUMENTATION - CRITICAL FOR CONTINUITY

### 6.1 Update Task List Progress

**File**: `PHASE_2_CHUNK_PROCESSING_TASKS.md`

1. **Find the specific task checkboxes** in the markdown and update them:
   - Change `[ ]` to `[~]` when starting a task (in progress)
   - Change `[~]` to `[x]` when completing a task

2. **Add any new discovered tasks** to the appropriate sections

### 6.2 Add/Update Handoff Notes Section

**Location**: **APPEND TO THE VERY END** of `PHASE_2_CHUNK_PROCESSING_TASKS.md`

**Format**: Add this section at the bottom of the file (create if it doesn't exist, replace if it does):

```markdown
---

## Last Work Session Notes

**Date**: [Current Date and Time]

**Completed Tasks**:
- [x] Task 0.1 - Documented current video flow
- [x] Task 1.1 - Created ChunkProcessor class
- [~] Task 2.3 - Modifying video serving endpoint (in progress)

**Current Status**:
[Describe what's currently working and what state the code is in]

**Next Priority**:
[Specific tasks that should be tackled next session, with reasoning]

**Blockers/Issues**:
[Any problems, errors, or dependencies blocking progress]

**Testing Notes**:
[How to test what was built, what commands to run]

**Implementation Notes**:
[Technical details about what was built, file locations, key decisions]

**Handoff Context**:
[Specific context the next session needs to know to pick up smoothly]
```

## 7. COMMON COMMANDS

```bash
# Start all services
docker-compose up --build -d

# View logs
docker-compose logs -f ml-service
docker-compose logs -f api-gateway

# Test ML processing
curl -X POST http://localhost:8002/api/process-chunk \
  -H "Content-Type: application/json" \
  -d '{"chunk_id": "test_001", "chunk_path": "/chunks/farm1/stream1/raw/chunk_001.mp4", "farm_id": "farm1", "stream_id": "stream1"}'

# Check ML service health
curl http://localhost:8002/health

# Restart a specific service
docker-compose restart ml-service

# Clean up and rebuild
docker-compose down
docker volume prune -f
docker-compose up --build -d
```

## IMPORTANT REMINDERS

1. **Update task list after EVERY work session** - This is critical for continuity
2. **Start with Phase 0 if fresh** - Map current video flow before changing it
3. **Test in Docker** - Don't assume local tests mean Docker works
4. **Modify existing endpoints** - Don't create parallel video playback systems
5. **Check frontend** - Ensure UI reflects backend changes
6. **Write logs** - Future you will thank current you

## START YOUR SESSION

Begin by saying: "Starting Phase 2 work session. Let me review the current state and select the next tasks to implement."

Then follow the steps above systematically.
```