# Phase 5: PTZ Auto-Scan - Task Execution

You are implementing **Phase 5** of BarnHand: intelligent PTZ auto-scan mode with snapshot detection and targeted recording.

## QUICK START

**Read these FIRST** (in order):
1. `docs/Phase 5 - PTZ Auto-Scan/ptz-auto-scan-tasks.md` - Find current task
2. `docs/HANDOFF_NOTES.md` - Last session context
3. `git status` - Current changes

**Phase 5 Docs**:
- **Overview**: `docs/Phase 5 - PTZ Auto-Scan/ptz-auto-scan-overview.md`
- **Tasks**: `docs/Phase 5 - PTZ Auto-Scan/ptz-auto-scan-tasks.md`

## TASK EXECUTION

### 1. Find Current Task

Look in `ptz-auto-scan-tasks.md` for:
- `[~]` = In progress (YOUR TASK)
- `[ ]` = Next task if none in progress

Read your task section: **Objective**, **Files**, **Steps**, **Testing**, **Acceptance**, **Reference**

### 2. Implement Task Steps

Follow steps in your task. For each step:
- Read "Reference" code pattern first
- Implement the step
- Commit: `p5(task-X.Y): <step description>`

## KEY PATTERNS

### Auto-Scan Types (Task 0.1)
```typescript
// shared/src/types/autoScan.types.ts
export interface AutoScanConfig {
  recordingDuration: number;   // 5-30 seconds
  frameInterval: number;       // 1-30
  movementDelay: number;       // 3-15 seconds (HLS delay compensation)
  presetSequence?: number[];   // Which presets to scan
}

export interface AutoScanState {
  phase: 'detection' | 'recording' | 'complete' | 'stopped' | 'error';
  currentPreset: number;
  totalPresets: number;
  results: PresetScanResult[];
  locationsWithHorses: number[];
}
```

### YOLO-Only Detection Endpoint (Task 1.1)
```python
# backend/ml-service/src/services/snapshot_detector.py
async def detect_horses_in_snapshot(image_bytes: bytes) -> dict:
    """Fast horse detection - YOLO only, no pose/ReID"""
    image = cv2.imdecode(np.frombuffer(image_bytes, np.uint8), cv2.IMREAD_COLOR)
    results = yolo_model(image, conf=0.3)  # Lower threshold for recall
    return {
        "horses_detected": len(results) > 0,
        "count": len(results),
        "detections": [{"bbox": box, "confidence": conf} for box, conf in results]
    }
```

### Auto-Scan Service (Task 1.2)
```typescript
// backend/api-gateway/src/services/autoScanService.ts
class AutoScanService {
  private activeScans: Map<string, AutoScanState> = new Map();

  async startScan(streamId: string, config: AutoScanConfig) {
    // 1. Get presets from stream config
    // 2. Initialize state
    // 3. Run detection phase
    // 4. Run recording phase for locations with horses
    // 5. Emit completion
  }

  private async runDetectionPhase(streamId: string, presets: number[]) {
    for (const preset of presets) {
      await this.movePTZToPreset(streamId, preset);
      await this.delay(1500); // Let camera settle
      const snapshot = await this.fetchSnapshot(streamId);
      const result = await this.detectHorses(snapshot);
      this.emitProgress(streamId, { preset, result });
    }
  }
}
```

### WebSocket Events (Task 1.6)
```typescript
// Emit to stream room
io.to(`stream:${streamId}`).emit('autoScan:position', {
  streamId,
  preset: 3,
  presetName: 'South Paddock',
  phase: 'detection',
  progress: 0.38
});
```

### Auto-Scan Dialog (Task 2.1)
```tsx
// frontend/src/components/AutoScanDialog.tsx
const AutoScanDialog: React.FC<Props> = ({ isOpen, streamId, onClose }) => {
  const [state, setState] = useState<AutoScanState | null>(null);

  useEffect(() => {
    socket.on('autoScan:position', (data) => {
      if (data.streamId === streamId) setState(prev => ({ ...prev, ...data }));
    });
    // ... other event listeners
    return () => socket.off('autoScan:position');
  }, [streamId]);

  return (
    <Dialog open={isOpen} onClose={onClose}>
      {/* Progress bar, current preset, results list */}
    </Dialog>
  );
};
```

## CRITICAL TASKS

**Task 0.2** (Credential Refactor):
- `PTZControls.tsx:42-55` - Remove localStorage reads
- `StreamSettings.tsx` - Add PTZ credentials section
- `streams.ts` - Read credentials from config, fallback to query params

**Task 1.1** (YOLO Detection):
- Create `snapshot_detector.py` with fast detection function
- Lower confidence threshold (0.3) for better recall
- Must complete in <500ms

**Task 1.2** (Auto-Scan Service):
- Two-phase approach: detection scan â†’ recording scan
- Use existing `videoChunkService.recordChunk()` for recordings
- Emit WebSocket events at each step

**Task 2.3** (Auto-Scan Button):
- Add green button to PrimaryVideoPlayer
- Don't switch tabs during auto-scan recording
- `PrimaryVideoPlayer.tsx:200-250` for button area

## QUICK DEBUG

```bash
# Test snapshot detection endpoint
curl -X POST http://localhost:8002/detect-snapshot \
  -F "image=@test_snapshot.jpg" | jq

# Check auto-scan state
curl http://localhost:8000/api/v1/streams/{streamId}/ptz/auto-scan/status | jq

# Watch WebSocket events
# In browser console:
socket.on('autoScan:position', console.log)

# Check PTZ preset storage
curl http://localhost:8000/api/v1/streams/{streamId} | jq '.config.ptzPresets'

# Test PTZ command (replace with your camera credentials)
curl "http://{camera}:8080/web/cgi-bin/hi3510/ptzctrl.cgi?-step=0&-act=goto&-number=1&usr={user}&pwd={password}"
```

## SERVICE REBUILD

```bash
# After ML changes
docker compose build ml-service && docker compose up -d ml-service

# After API changes
docker compose build api-gateway && docker compose up -d api-gateway

# After frontend changes
cd frontend && npm run build
```

## CONFIGURATION REFERENCE

```typescript
// Stream config structure after refactor
streams.config = {
  // PTZ auth (moved from localStorage)
  ptzCredentials: { username: 'admin', password: 'your-camera-password' },

  // Presets (moved from localStorage)
  ptzPresets: {
    '1': { name: 'North Barn', savedAt: '2024-01-15T10:00:00Z' },
    '2': { name: 'South Paddock', savedAt: '2024-01-15T10:05:00Z' },
  },

  // Auto-scan settings (new)
  autoScan: {
    recordingDuration: 10,  // seconds
    frameInterval: 5,        // process every 5th frame
    movementDelay: 8,        // seconds to wait for HLS
  }
}
```

---

**NOW**: Check `docs/Phase 5 - PTZ Auto-Scan/ptz-auto-scan-tasks.md` for your current task and execute.
