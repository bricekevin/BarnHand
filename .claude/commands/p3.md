# Phase 3: Stream Horse Registry - Task Execution

You are implementing **Phase 3** of BarnHand: persistent per-stream horse registry with UI management.

## QUICK START

**Read these FIRST** (in order):

1. `docs/Phase 3 - Stream Horse Registry/stream-horse-registry-tasks.md` - Find current task
2. `docs/HANDOFF_NOTES.md` - Last session context
3. `git status` - Current changes

**Phase 3 Docs**:

- **Overview**: `docs/Phase 3 - Stream Horse Registry/stream-horse-registry-overview.md`
- **Tasks**: `docs/Phase 3 - Stream Horse Registry/stream-horse-registry-tasks.md`

## TASK EXECUTION

### 1. Find Current Task

Look in `stream-horse-registry-tasks.md` for:

- `[~]` = In progress (YOUR TASK)
- `[ ]` = Next task if none in progress

Read your task section: **Objective**, **Files**, **Steps**, **Testing**, **Acceptance**, **Reference**

### 2. Implement Task Steps

Follow steps 1-7 in your task. For each step:

- Read "Reference" code pattern first
- Implement the step
- Commit: `p3(task-X.Y): <step description>`

**Key Patterns**:

```typescript
// Backend API (Task 1.3)
router.get('/:id/horses', requireRole([...]), createAuthenticatedRoute(async (req, res) => {
  const horses = await streamHorseService.getStreamHorses(req.params.id, req.user.farmId);
  return res.json({ horses });
}));
```

```python
# ML Integration (Task 1.4) - CRITICAL
async def process_chunk(chunk_id: str, stream_id: str):
    # Load known horses BEFORE processing
    known_horses = await horse_db.load_stream_horse_registry(stream_id)
    tracker = HorseTracker(stream_id=stream_id, known_horses=known_horses)
    # ... process ...
    # Save horses AFTER processing
    await horse_db.save_stream_horse_registry(stream_id, tracker.get_all_tracks())
```

```typescript
// Frontend Tab (Task 2.1, 2.4)
const tabs = [
  { id: 'live', label: 'Live Stream' },
  { id: 'chunks', label: 'Recorded Chunks' },
  { id: 'horses', label: 'Detected Horses' }, // NEW
];
```

### 3. Test (Complete ALL before next task)

Check off boxes in task "Testing" section:

- [ ] Unit tests
- [ ] Integration tests
- [ ] Regression tests
- [ ] Manual tests

```bash
# Test commands
docker compose up -d --build [ml-service|api-gateway|frontend]
docker compose logs -f [service]
cd frontend && npm test
```

### 4. Mark Complete

Update task in `stream-horse-registry-tasks.md`:

- Change `[ ]` to `[x]` when all Testing + Acceptance boxes checked
- Update `docs/HANDOFF_NOTES.md` with progress

## CRITICAL TASKS

**Task 1.4** (ML Integration):

- Load horses at `processor.py:200`, save at `processor.py:450`
- Test: 2 chunks with same horse â†’ verify same ID

**Task 2.4** (Tab Integration):

- Add tab at `PrimaryVideoPlayer.tsx:50-80`

**Task 3.1** (WebSocket):

- Add `streamHorses` to Zustand store
- Subscribe to `horses:detected` events

## QUICK DEBUG

```bash
# Horse not persisting?
docker compose exec redis redis-cli KEYS "horse:*"
docker compose exec postgres psql -U barnhand -c "SELECT tracking_id, stream_id FROM horses"

# Name not showing?
curl localhost:8000/api/v1/streams/[id]/chunks/[chunkId]/detections | jq '.detections[0].horse_name'
```

---

**NOW**: Check `docs/Phase 3 - Stream Horse Registry/stream-horse-registry-tasks.md` for your current task and execute steps 1-4.
