# Phase 2: ML Chunk Processing Task List

## Phase 0: Map Current System âœ… COMPLETE

- [x] Document current video playback flow - find where videos are served
- [x] Find video serving endpoint (api-gateway/routes)
- [x] Find frontend video URL construction
- [x] Find chunk storage/retrieval logic
- [x] Output findings to `CURRENT_VIDEO_FLOW.md`
- [x] Update the following tasks as needed to ensure well aligned with current

## Phase 1: ML Service Core

### 1.1 ChunkProcessor âœ… COMPLETE

- [x] ChunkProcessor already exists in `backend/ml-service/src/services/processor.py`
- [x] Added `process_chunk_with_video_output()` method to existing ChunkProcessor
- [x] Accept: chunk_id, chunk_path, farm_id, stream_id, output_video_path, output_json_path
- [x] Output processed video to: `/chunks/{farmId}/{streamId}/processed/{chunkId}_processed.mp4`
- [x] Output JSON to: `/chunks/{farmId}/{streamId}/detections/{chunkId}_detections.json`
- [x] JSON schema: video_metadata, summary, horses[], frames[] with full detection data
- [x] **Phase 1.1.1**: Fixed OpenCV codec issue with FFmpeg-based video writing
- [x] Test standalone processing - **WORKING**

### 1.2 ML Service Endpoint âœ… COMPLETE

- [x] Add `POST /api/process-chunk` to `backend/ml-service/src/main.py`
- [x] Accept: chunk_id, chunk_path, farm_id, stream_id, output paths
- [x] Call ChunkProcessor.process_chunk_with_video_output()
- [x] Return: processed_video_path, detections_path, status, summary
- [~] Test with curl (blocked by codec issue)

### 1.3 Verify Models âœ… ALL MODELS FULLY OPERATIONAL

- [x] Test YOLO loads in Docker - âœ… Both primary and fallback models loaded
- [x] Test RTMPose loads in Docker - âœ… **REAL MMPose loaded successfully!**
- [x] Test MegaDescriptor ReID loads in Docker - âœ… MegaDescriptor operational
- [x] Check `docker-compose logs ml-service` - âœ… **All models working without fallbacks**

### 1.4 Fix RTMPose mmcv Installation âœ… COMPLETE

- [x] Install openmim for mmcv management
- [x] Install torch before running mim (version detection requirement)
- [x] Use mim to install mmcv with compiled extensions
- [x] Verify RTMPose loads with full MMPose framework
- [x] **Result: RTMPose now fully operational with real model!**

## Phase 2: API Gateway Integration âœ… COMPLETE

### 2.1 Database Schema âœ…

- [x] Add columns to video_chunks table:
  - [x] detections_path TEXT
  - [x] ml_processed BOOLEAN DEFAULT FALSE
  - [x] processing_status TEXT (enum: pending/queued/processing/complete/failed/timeout)
  - [x] processing_time_seconds FLOAT
  - [x] ml_started_at TIMESTAMPTZ
  - [x] ml_completed_at TIMESTAMPTZ
- [x] Run migration (003_ml_processing_columns.sql)
- [x] Added indexes for ml_processed and processing_queue
- Note: processed_path already existed in schema

### 2.2 Update Record-Chunk âœ…

- [x] Modified `backend/api-gateway/src/services/videoChunkService.ts`
- [x] Added `triggerMLProcessing()` method to VideoChunkService
- [x] Call ML service async: `POST http://ml-service:8002/api/process-chunk`
- [x] Fire-and-forget pattern - doesn't block client response
- [x] Creates processed/ and detections/ subdirectories
- [x] Graceful failure handling - chunk recording succeeds even if ML trigger fails

### 2.3 Modify Video Serving âœ…

- [x] Find current video serving endpoint - `videoChunkService.ts:568-614` (Phase 0)
- [x] `/chunks` endpoint already exists in video-streamer (app.ts:73)
- [x] Modified `getChunkStreamUrl()` to check for processed video
- [x] Returns processed URL: `/chunks/{farmId}/{streamId}/processed/{filename}_processed.mp4`
- [x] Falls back to raw: `/chunks/{farmId}/{streamId}/{filename}`
- [x] Added forceRaw parameter (default: false)
- [x] Route supports `?raw=true` query parameter
- [x] Returns `isProcessed` flag in response

### 2.4 Add Detections Endpoint âœ…

- [x] Created `GET /api/v1/streams/:id/chunks/:chunkId/detections`
- [x] Added `getChunkDetections()` to VideoChunkService
- [x] Reads JSON from `/chunks/{farmId}/{streamId}/detections/{filename}_detections.json`
- [x] Returns full parsed JSON object
- [x] Returns 404 if detections not found (chunk not processed yet)

### 2.5 Add Status Endpoint âœ…

- [x] Created `GET /api/v1/streams/:id/chunks/:chunkId/status`
- [x] Added `getChunkStatus()` to VideoChunkService
- [x] Returns: chunk_id, recording_status, ml_processed, processing_status, has_processed_video, has_detections
- [x] Determines status by checking file existence
- [x] Status states: pending (no files), processing (partial), complete (both files)

## Phase 3: Frontend Display

### 3.1 Update Video URL Logic

- [ ] Find current video URL construction
- [ ] Check processing status before building URL
- [ ] Use same endpoint (backend now serves processed automatically)
- [ ] Add `?raw=true` when raw toggle is on
- [ ] Test: video switches from raw to processed

### 3.2 Update VideoPlayer Component

- [ ] Add "Show Raw Video" toggle to `frontend/src/components/VideoPlayer.tsx`
- [ ] When on: append `?raw=true` to video URL
- [ ] Add processing status badge: "ðŸ”„ Processing..." or "âœ“ Processed"
- [ ] Test toggle switches between raw/processed

### 3.3 Create Detection Data Panel

- [ ] Create `frontend/src/components/DetectionDataPanel.tsx`
- [ ] Fetch: `GET /api/v1/chunks/${chunkId}/detections`
- [ ] Display summary: horse count, processing time, frame count
- [ ] Display horse list: ID, color, state distribution, confidence
- [ ] Add frame timeline scrubber
- [ ] Add collapsible raw JSON view
- [ ] Test: displays all detection data

### 3.4 Update Chunk List Status

- [ ] Modify chunk list component
- [ ] Show status badge: Processing/Processed/Failed/Raw
- [ ] Poll status every 2s while processing
- [ ] Display processing time
- [ ] Test: status updates in real-time

### 3.5 Add Download Options

- [ ] Add download buttons: Processed video, Raw video, Detections JSON
- [ ] Test downloads

## Phase 4: Testing & Polish

### 4.1 End-to-End Video Playback

- [ ] Start docker-compose
- [ ] Record 5 second chunk
- [ ] Verify: plays raw immediately
- [ ] Wait for processing
- [ ] Verify: automatically switches to processed (overlays visible)
- [ ] Toggle "Show Raw"
- [ ] Verify: raw video displays (no overlays)
- [ ] Toggle off
- [ ] Verify: processed video returns

### 4.2 End-to-End Detection Data

- [ ] Open processed chunk
- [ ] Verify: detection panel shows summary
- [ ] Verify: horse list displays
- [ ] Verify: timeline scrubber works
- [ ] Click timeline points
- [ ] Verify: video jumps to frame
- [ ] Expand raw JSON
- [ ] Verify: full data visible
- [ ] Download detections JSON
- [ ] Verify: file contains frame data

### 4.3 Performance

- [ ] Make ML processing async
- [ ] Add Redis processing queue
- [ ] Auto-refresh when processing completes
- [ ] Cache processed videos
- [ ] Set 30s processing timeout
- [ ] Test multiple concurrent recordings

### 4.4 Error Handling

- [ ] Handle ML service down - show "Processing unavailable"
- [ ] Handle processing timeout - mark failed after 60s
- [ ] Handle missing models - graceful degradation
- [ ] Handle corrupted video - catch errors, mark failed
- [ ] Log errors with correlation IDs
- [ ] Test each error scenario

### 4.5 Documentation

- [ ] Update README with video playback flow
- [ ] Create `VIDEO_PLAYBACK.md`
- [ ] Add code comments to video serving logic

## Definition of Done

- [ ] Record chunk â†’ ML processes automatically
- [ ] Video plays raw immediately, switches to processed when ready
- [ ] Processed video shows: bounding boxes, IDs, pose keypoints
- [ ] Horse IDs persist across chunks
- [ ] Detection panel displays: count, states, timeline, JSON
- [ ] Toggle between raw/processed views
- [ ] Processing status visible
- [ ] Processing <30s for 10s chunk
- [ ] End-to-end test passes

---

## Last Work Session Notes

**Date**: 2025-10-07 (Session 5 - Phase 2: API Gateway Integration COMPLETE âœ…)

**Completed Tasks**:

### Phase 2: API Gateway Integration - ALL 5 PHASES COMPLETE âœ…

- [x] **Phase 2.1** - Database schema with ML processing columns
- [x] **Phase 2.2** - Automatic ML processing trigger on chunk recording
- [x] **Phase 2.3** - Smart video serving (processed when available, raw fallback)
- [x] **Phase 2.4** - Detections endpoint for ML data retrieval
- [x] **Phase 2.5** - Status endpoint for processing state tracking

**Current Status**:
**Phase 2: API Gateway Integration - 100% COMPLETE** âœ…

**Implementation Summary**:

### Phase 2.1: Database Schema âœ…

**Migration**: `backend/database/src/migrations/sql/003_ml_processing_columns.sql`

Added columns to `video_chunks` table:

- `detections_path TEXT` - Path to JSON detection data
- `ml_processed BOOLEAN DEFAULT FALSE` - Processing completion flag
- `processing_status VARCHAR(50)` - Status enum (pending/queued/processing/complete/failed/timeout)
- `processing_time_seconds FLOAT` - Performance tracking
- `ml_started_at TIMESTAMPTZ` - Start timestamp
- `ml_completed_at TIMESTAMPTZ` - Completion timestamp

Indexes created:

- `idx_video_chunks_ml_processed` - Query processed chunks
- `idx_video_chunks_processing_queue` - Queue management

**Note**: `processed_path` already existed in initial schema

### Phase 2.2: Automatic ML Processing Trigger âœ…

**File**: `backend/api-gateway/src/services/videoChunkService.ts`

New method: `triggerMLProcessing(chunk: VideoChunk)`

- Creates `processed/` and `detections/` subdirectories
- Builds output paths for processed video and JSON
- Calls ML service: `POST http://ml-service:8002/api/process-chunk`
- Fire-and-forget async pattern (doesn't block client)
- Graceful failure handling

Integration point: After chunk recording completes (line 289)

Request payload:

```json
{
  "chunk_id": "uuid",
  "chunk_path": "/app/storage/chunks/farm1/stream1/chunk_xxx.mp4",
  "farm_id": "farm1",
  "stream_id": "stream1",
  "output_video_path": "/app/storage/chunks/farm1/stream1/processed/chunk_xxx_processed.mp4",
  "output_json_path": "/app/storage/chunks/farm1/stream1/detections/chunk_xxx_detections.json"
}
```

### Phase 2.3: Smart Video Serving âœ…

**Files Modified**:

- `backend/api-gateway/src/services/videoChunkService.ts:568-614`
- `backend/api-gateway/src/routes/streams.ts:466-485`

Method: `getChunkStreamUrl(chunkId, farmId, forceRaw=false)`

Logic:

1. If `forceRaw=false`: Check if processed video exists
2. If exists: Return `/chunks/{farmId}/{streamId}/processed/{filename}_processed.mp4`
3. Else: Return `/chunks/{farmId}/{streamId}/{filename}` (raw)
4. If `forceRaw=true`: Always return raw video

Route enhancement:

- Accepts `?raw=true` query parameter
- Returns `isProcessed` flag in response

Video-streamer integration:

- `/chunks` endpoint already configured (app.ts:73)
- Serves all files from chunk storage path

### Phase 2.4: Detections Endpoint âœ…

**Route**: `GET /api/v1/streams/:id/chunks/:chunkId/detections`
**File**: `backend/api-gateway/src/routes/streams.ts:493-529`

Method: `getChunkDetections(chunkId, farmId)`

Behavior:

- Reads JSON from `/chunks/{farmId}/{streamId}/detections/{filename}_detections.json`
- Returns parsed JSON object with full frame data
- Returns 404 if file not found (chunk not processed yet)

Response structure:

```json
{
  "video_metadata": { "fps": 30, "duration": 5, "resolution": "1920x1080", "total_frames": 150 },
  "summary": { "total_horses": 2, "total_detections": 145, "processing_time_ms": 12500 },
  "horses": [{ "id": "horse_001", "color": [255, 87, 51], ... }],
  "frames": [{ "frame_index": 0, "timestamp": 0.0, "detections": [...], ... }]
}
```

### Phase 2.5: Status Endpoint âœ…

**Route**: `GET /api/v1/streams/:id/chunks/:chunkId/status`
**File**: `backend/api-gateway/src/routes/streams.ts:532-565`

Method: `getChunkStatus(chunkId, farmId)`

Status determination:

- Checks for processed video file existence
- Checks for detections JSON file existence
- Derives `ml_processed` and `processing_status` from files

Response:

```json
{
  "chunk_id": "uuid",
  "recording_status": "completed",
  "ml_processed": true,
  "processing_status": "complete",
  "has_processed_video": true,
  "has_detections": true,
  "file_size": 1234567,
  "duration": 5,
  "created_at": "2025-10-07T..."
}
```

Status states:

- `pending` - No ML files found (not started)
- `processing` - Partial files exist (in progress)
- `complete` - Both processed video and detections exist

**Key Design Decisions**:

1. **File-based status tracking** (temporary until database integration)
   - Status derived from file existence checks
   - Simple, reliable, no database dependency yet
   - Easy to migrate to database later (TODO markers in code)

2. **Fire-and-forget ML processing**
   - Client gets immediate response after chunk recording
   - ML processing happens in background
   - Frontend can poll status endpoint for updates

3. **Smart video serving with fallback**
   - Automatically serves processed video when available
   - Gracefully falls back to raw if not ready
   - `?raw=true` parameter for debugging/comparison

4. **Reused existing infrastructure**
   - video-streamer `/chunks` endpoint already configured
   - No new services needed
   - Minimal code changes to existing flow

**Complete Flow (End-to-End)**:

1. User calls: `POST /api/v1/streams/:id/record-chunk`
2. API Gateway records raw video chunk via FFmpeg
3. After recording completes: ML processing triggered (async)
4. ML Service processes chunk and generates outputs
5. Frontend can immediately play raw video
6. Frontend polls status endpoint for completion
7. When complete, video automatically switches to processed version

**Next Priority**: Phase 3 - Frontend Display

**Testing Notes**:

Not yet tested end-to-end - services are running but need:

1. Restart api-gateway to load new code
2. Record a test chunk
3. Verify ML processing triggers
4. Check processed video and JSON are created

Commands to test:

```bash
# Restart API Gateway
docker compose restart api-gateway

# Record a 5-second chunk (via frontend or curl)
# Then check status
curl http://localhost:8000/api/v1/streams/stream1/chunks/{chunkId}/status

# Check for processed files
docker compose exec api-gateway ls -la /app/storage/chunks/*/*/processed/
docker compose exec api-gateway ls -la /app/storage/chunks/*/*/detections/
```

**Git Commits (Session 5)**:

- `fdbef7c` - feat: add ML processing trigger to chunk recording flow
- `487a360` - feat: modify video serving to check for processed chunks
- `51ae6e8` - feat: add detections endpoint for chunk ML data
- `3c82754` - feat: add status endpoint for chunk processing state

**Handoff Context**:

Phase 2 is complete! The API layer is now ready for ML chunk processing. The next session should focus on Phase 3 - Frontend Display:

1. **Phase 3.1**: Update video URL construction in frontend
2. **Phase 3.2**: Add "Show Raw Video" toggle to VideoPlayer component
3. **Phase 3.3**: Create Detection Data Panel component
4. **Phase 3.4**: Add processing status badges to chunk list
5. **Phase 3.5**: Add download options for videos and JSON

**Important Notes for Next Session**:

- âœ… All backend endpoints implemented and ready
- âœ… Database migration applied
- âœ… ML processing integration complete
- âš ï¸ **Testing needed**: End-to-end flow not yet verified
- ðŸ“ All code has TODO markers for future database integration
- ðŸ“‚ File structure: `/chunks/{farmId}/{streamId}/[processed|detections]/{filename}`

**Known Limitations / TODOs**:

1. Database not yet integrated - using file-based status checks
2. No database updates on ML completion (marked with TODO comments)
3. No Redis queue for processing (fire-and-forget for now)
4. No timeout handling (30s limit not enforced)
5. No error notifications to frontend (frontend would need to poll status)
6. Processing time not tracked yet

These are all marked in the code and can be addressed when integrating the database layer.
